#!/bin/sh
# Pre-commit hook para Carbon Finance
# Previne commits perigosos e avisa sobre arquivos cr√≠ticos

set -e

# Cores para output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "${GREEN}üîç Verificando commit...${NC}"

# 1. Verificar se foi usado git add . (pattern perigoso)
STAGED_FILES=$(git diff --cached --name-only)

if [ -z "$STAGED_FILES" ]; then
    echo "${YELLOW}‚ö†Ô∏è  Nenhum arquivo em stage para commit${NC}"
    exit 1
fi

# 2. Avisar se arquivos cr√≠ticos foram modificados
CRITICAL_FILES="index.html README.md vite.config.ts vercel.json BASELINE.md package.json"

for critical in $CRITICAL_FILES; do
    if echo "$STAGED_FILES" | grep -q "^$critical$"; then
        echo "${YELLOW}‚ö†Ô∏è  AVISO: Arquivo cr√≠tico '$critical' foi modificado!${NC}"
        echo "${YELLOW}   Revise cuidadosamente as mudan√ßas antes de fazer commit.${NC}"
        echo "${YELLOW}   Use: git diff --cached $critical${NC}"
    fi
done

# 3. Verificar por quebras de linha acidentais
SUSPICIOUS_CHANGES=$(git diff --cached -U0 | grep -E "^\+.*[[:space:]]$" || true)

if [ -n "$SUSPICIOUS_CHANGES" ]; then
    echo "${YELLOW}‚ö†Ô∏è  AVISO: Espa√ßos ou quebras de linha suspeitas detectadas!${NC}"
    echo "$SUSPICIOUS_CHANGES"
fi

# 4. Validar mensagem de commit (ser√° validada no commit-msg)
echo "${GREEN}‚úÖ Pr√©-commit verifica√ß√£o conclu√≠da!${NC}"
echo "${GREEN}   Revise suas mudan√ßas com: git diff --cached${NC}"

exit 0
